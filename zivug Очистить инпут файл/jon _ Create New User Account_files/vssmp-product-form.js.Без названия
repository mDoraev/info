var vssmp_image_index = 0;
var vssmp_pro_img_row = '';
var sub_product_list_dt;
var rel_product_list_dt;
var rel_load_first_time = true;
var file_upload_index = 0;
var flagSubmit;

jQuery(document).ready(function(){  

var danast = jQuery('.vssmp-product-img-body tr');
console.log(danast);
    jQuery.each(danast, function(id, val){
        if(id > 2){
            jQuery(val).hide();
           jQuery(val).find('input').val('1'); 
        }
    })

    
    if(jQuery('#vssmp_category_mapping_list').length){
        jQuery("#vssmp_category_mapping_list").multipleSelect({
            placeholder: "Select Category",
            charReplace: category_child_rel_symbol
        });
    }
    
    jQuery(document.body).on('focus', '#vssmp-product-form-inner input[type="text"],#vssmp-product-form-inner textarea, #vssmp-simple-product-popup input[type="text"], #vssmp-simple-product-popup textarea', function(){
        if(jQuery(this).hasClass('vssmp-hlyt-inv-field')){
            jQuery(this).removeClass('vssmp-hlyt-inv-field');
        }
        if(jQuery(this).attr('data-placeholder')){
            var orig_placeholder = jQuery(this).attr('data-placeholder');
            var field_placeholder = jQuery(this).attr('value');
            if(orig_placeholder.toLowerCase() == field_placeholder.toLowerCase()){
                jQuery(this).attr('value', '');
            }    
        } 
    });
    
    jQuery(document.body).on('blur', '#vssmp-product-form-inner input[type="text"]', function(){
        if(jQuery(this).attr('data-placeholder')){
            var orig_placeholder = jQuery(this).attr('data-placeholder');
            var field_placeholder = jQuery(this).attr('value');
            if(field_placeholder == '' || (orig_placeholder.toLowerCase() == field_placeholder.toLowerCase())){
                jQuery(this).attr('value', orig_placeholder);
            }    
        }
        
    });

    jQuery('body').on('change', '.vssmp-product-image-upl-file', function(){

        file_upload_index = jQuery(this).attr('data-index');
        var maxsize = 10000000;
        var size_echo = parseInt(maxsize/1000000);
        if (this.files && this.files[0]) {
            if(this.files[0].size < maxsize){
                var reader = new FileReader();
                reader.onload = vssmpImageIsLoaded;
                reader.readAsDataURL(this.files[0]);
            }
            else {

                jQuery(this).parent().prepend('<h3 class="resqui" style="color:#bb2929;">Max size  '+size_echo+" Mb</h3>");
                    jQuery(this).replaceWith(jQuery(this).clone());

                timer = setTimeout(function () {
                    jQuery('.resqui').animate({opacity :  "0"} , 'slow',function() {
                        jQuery('.resqui').remove();


                    });
                    }, 2000);
            }
        }
    });

    //Sub Product List
    if(jQuery('#vssmp_sub_products').length){
        sub_product_list_dt = jQuery('#vssmp_sub_products').dataTable( {
                "pageLength": vssmp_dt_page_length,
                "lengthChange": false,
                "searching": false,
                "processing": true,
                "serverSide": true,
                "ajax": {
                        "url": vssmp_subproducts_datatable_url+'?ajax=true&isAjax=true',
                        "type": "POST",
                        "data": function ( param ) {
                            if(sub_product_parent == 'grouped'){
                                param.checked_products = jQuery('#vssmp_associate_container input[name="product[sub_products]"]').attr('value');
                            }else if(sub_product_parent == 'configurable'){
                                param.checked_products = jQuery('#vssmp_associate_container input[name="sub_product_keys"]').attr('value');
                            }
                            
                            param.sub_load_first_time = sub_load_first_time;
                            param.list_params = product_list_params;
                            param.product_id = ((jQuery('#sub-pro-list-filter-list input[name="sub_pro_filter_id"]').val() != jQuery('#sub-pro-list-filter-list input[name="sub_pro_filter_id"]').attr('data-placeholder'))? jQuery('#sub-pro-list-filter-list input[name="sub_pro_filter_id"]').val() : '');
                            param.sku = ((jQuery('#sub-pro-list-filter-list input[name="sub_pro_filter_sku"]').val() != jQuery('#sub-pro-list-filter-list input[name="sub_pro_filter_sku"]').attr('data-placeholder'))? jQuery('#sub-pro-list-filter-list input[name="sub_pro_filter_sku"]').val() : '');
                            param.name = ((jQuery('#sub-pro-list-filter-list input[name="sub_pro_filter_name"]').val() != jQuery('#sub-pro-list-filter-list input[name="sub_pro_filter_name"]').attr('data-placeholder'))? jQuery('#sub-pro-list-filter-list input[name="sub_pro_filter_name"]').val() : '');
                            param.inv_status = ((jQuery('#sub-pro-list-filter-list select[name="sub_pro_filter_inv_status"]').val() != '')? jQuery('#sub-pro-list-filter-list select[name="sub_pro_filter_inv_status"]').val() : '');
                            param.attr_set = ((jQuery('#sub-pro-list-filter-list select[name="sub_pro_filter_attr_set"]').val() != '')? jQuery('#sub-pro-list-filter-list select[name="sub_pro_filter_attr_set"]').val() : '');
                        }
                    },
                "initComplete": function(settings, json) {
                    sub_load_first_time = false;
                },
                "columnDefs": [ 
                    {
                        className: "vssmp-txt-cntr",
                        orderable: false,
                        searchable: false,
                        "targets": 0
                    },
                    {name: 'entity_id', "targets": 1, className: "vssmp-txt-ryt"},
                    {name: 'name', "targets": 2},
                    {name: 'sku', "targets": 3},
                    {name: 'attribute_set_id', "targets": 4},
                    {name: 'price', "targets": 5, className: "vssmp-txt-ryt"},
                    {name: 'inventory_in_stock', "targets": 6}
                ]
        } );   
    }

    //Related Product List
    if(jQuery('#vssmp_rel_products').length){
        rel_product_list_dt = jQuery('#vssmp_rel_products').dataTable( {
                "pageLength": vssmp_dt_page_length,
                "lengthChange": false,
                "searching": false,
                "processing": true,
                "serverSide": true,
                "ajax": {
                        "url": vssmp_relproducts_datatable_url+'?ajax=true&isAjax=true',
                        "type": "POST",
                        "data": function ( param ) {
                            param.checked_products = jQuery('#vssmp_related_container input[name="product[rel_products]"]').attr('value');
                            param.rel_load_first_time = rel_load_first_time;
                            param.list_params = product_list_params;
                            param.product_id = ((jQuery('#rel-pro-list-filter-list input[name="sub_pro_filter_id"]').val() != jQuery('#rel-pro-list-filter-list input[name="sub_pro_filter_id"]').attr('data-placeholder'))? jQuery('#rel-pro-list-filter-list input[name="sub_pro_filter_id"]').val() : '');
                            param.sku = ((jQuery('#rel-pro-list-filter-list input[name="sub_pro_filter_sku"]').val() != jQuery('#rel-pro-list-filter-list input[name="sub_pro_filter_sku"]').attr('data-placeholder'))? jQuery('#rel-pro-list-filter-list input[name="sub_pro_filter_sku"]').val() : '');
                            param.name = ((jQuery('#rel-pro-list-filter-list input[name="sub_pro_filter_name"]').val() != jQuery('#rel-pro-list-filter-list input[name="sub_pro_filter_name"]').attr('data-placeholder'))? jQuery('#rel-pro-list-filter-list input[name="sub_pro_filter_name"]').val() : '');
                            param.inv_status = ((jQuery('#rel-pro-list-filter-list select[name="sub_pro_filter_inv_status"]').val() != '')? jQuery('#rel-pro-list-filter-list select[name="sub_pro_filter_inv_status"]').val() : '');
                            param.attr_set = ((jQuery('#rel-pro-list-filter-list select[name="sub_pro_filter_attr_set"]').val() != '')? jQuery('#rel-pro-list-filter-list select[name="sub_pro_filter_attr_set"]').val() : '');
                        }
                    },
                    "initComplete": function(settings, json) {
                        rel_load_first_time = false;
                    },
                "columnDefs": [ 
                    {
                        className: "vssmp-txt-cntr",
                        orderable: false,
                        searchable: false,
                        "targets": 0
                    },
                    {name: 'entity_id', "targets": 1, className: "vssmp-txt-ryt"},
                    {name: 'name', "targets": 2},
                    {name: 'sku', "targets": 3},
                    {name: 'attribute_set_id', "targets": 4},
                    {name: 'price', "targets": 5, className: "vssmp-txt-ryt"},
                    {name: 'inventory_in_stock', "targets": 6}
                ]
        } );    
    }
    
});

function setSettings(url, attribute_set_id, product_type)
{
    url = url.replace('{{attribute_set}}', jQuery('#'+attribute_set_id).val());
    url = url.replace('{{type}}', jQuery('#'+product_type).val());
    location.href = url;
}

function validateSuperSettings() {
    jQuery('#vssmp-product-form .vssmp-glob-warning').remove();
    
    if(jQuery('.attribute-checkbox:checked').length == 0){
        jQuery('<div class="vssmp-glob-warning">'+attribute_setting_selection_error+'</div>').insertBefore(jQuery('#vssmp-product-attribute-set-form'));
    }else{
        jQuery('#product-process-step2-form').submit();
    }
}

function show_10_image(){

    var id_elemtr = jQuery('#vssmp-product-img-body tr');
    // console.log(id_elemtr);
    var i = 0;
    id_elemtr.each(function(){
        if(jQuery(this).hasClass("element_image")){
        i++;
        }
    })
    // console.log(i);
    if(i >= 5){
        jQuery('.vss-btn-orange').parent().hide();
    }else{
        jQuery('.vss-btn-orange').parent().show();
    }
}

function createImageRow(json_data)
{   
    
    var data = {};
    jQuery('#vssmp-img-ext-err').hide();
    vssmp_image_index = vssmp_image_index+1;
    vssmp_pro_img_row = '';
    vssmp_pro_img_row += '<tr class="element_image" id="vssmp-image'+vssmp_image_index+'">';
    vssmp_pro_img_row += '<td class="cell-image">';

    vssmp_pro_img_row += "<input type='hidden' name='product[gallery]["+vssmp_image_index+"][delete]' value='' />";
    vssmp_pro_img_row += "<input type='hidden' name='product[gallery]["+vssmp_image_index+"][old_data]' value='"+json_data+"' />";


    if(json_data == '[]'){
        data = {
            value_id: 0,
            url: '',
            label: '',
            position: 0,
        };
        vssmp_pro_img_row += '<div class="vssmp-row-block vssmp-pro-img-preview" style="display:none;"><img src="'+data.url+'" title="'+data.label+'" width="100"></div>';
    }else{
        data = jQuery.parseJSON(json_data);
        vssmp_pro_img_row += '<div class="vssmp-row-block vssmp-pro-img-preview"><img src="'+data.url+'" title="'+data.label+'" width="100"></div>';
    }
    
    vssmp_pro_img_row += '<div class="vssmp-row-block"><input class="vssmp-product-image-upl-file vssmp-no-display" name="media_gallery['+vssmp_image_index+']" type="file" value="" data-index="'+vssmp_image_index+'"/><button type="button" class="vssmp-button vss-btn-grey vssmp-no-margin" onclick="startImageUpload(this)"><span>Browse</span></button></div>';
    vssmp_pro_img_row += '</td>';
    vssmp_pro_img_row += '<td class="cell-label"><input type="text" name="product[gallery]['+vssmp_image_index+'][label]" class="custom-input-field input-width3 vssmp_validate_varchar" value="'+data.label+'"/></td>';
    vssmp_pro_img_row += '<td class="cell-position"><input type="text" name="product[gallery]['+vssmp_image_index+'][position]" class="custom-input-field input-width3 vssmp_validate_int" value="'+data.position+'" /></td>';
    for(var i=0; i<vssmp_image_types.length; i++)
    {
        var checked = '';
        var value_image = vssmp_image_types[i]['id'];
        if(data[value_image] != undefined && data[value_image] == 1){
            checked = 'checked="checked"';
        }
        vssmp_pro_img_row += '<td class="vssmp-txt-cntr cell-'+vssmp_image_types[i]['id']+'"><input type="radio" name="product['+vssmp_image_types[i]['id']+']" value="'+vssmp_image_index+'" '+checked+'/></td>';
    }

    vssmp_pro_img_row += '<td class="vssmp-txt-cntr cell-remove"><span class="vssmp_remove_img" onclick="removeVssProductImage('+vssmp_image_index+', true)"/></td>';
    vssmp_pro_img_row += '</tr>';
    jQuery('#vssmp-product-img-body #product-image-blank-row').remove();
    jQuery('#vssmp-product-img-body').append(vssmp_pro_img_row);
    vssmpProcessImageDefaultSelection();
    show_10_image();
}

function vssmpProcessImageDefaultSelection()
{
        if(jQuery('#vssmp-product-img-body tr').length == 1){
            jQuery('#vssmp-product-img-body tr#vssmp-image'+vssmp_image_index+' input[type="radio"]').each(function(){
                jQuery(this).attr('checked', 'checked');
            });
        }    
}


function startImageUpload(e)
{
    jQuery(e).parent().find('input[type="file"]').trigger('click');
}

function checkMediaUpload(val)
{

    for(var i=0; i<vssmp_pro_img_format.length; i++)
    {
        var str = 'image/'+vssmp_pro_img_format[i];
        if(val.indexOf(str.toLowerCase()) > -1){
            return true;
        }
    }
    return false;
}

function vssmpImageIsLoaded(e) {

    if(checkMediaUpload(e.target.result)){
        var container = 'tr#vssmp-image'+file_upload_index+' td.cell-image .vssmp-pro-img-preview';
        jQuery(container+' img').attr('src', e.target.result);
        jQuery(container).show();
    }else{
        removeVssProductImage(file_upload_index, false);
        jQuery('#vssmp-img-ext-err').show();
        jQuery('tr#vssmp-image'+vssmp_image_index).remove();
    }
    
};

function removeVssProductImage(image_row_id, hide)
{   
    var this_image = jQuery('#vssmp-image'+image_row_id).find('.vssmp-txt-cntr.cell-image input');

    jQuery('#vssmp-img-ext-err').hide();
    jQuery('#vssmp-image'+image_row_id+' input[name="product[gallery]['+image_row_id+'][delete]"]').attr('value', 1);
    var container = 'tr#vssmp-image'+image_row_id+' td.cell-image .vssmp-pro-img-preview';
    jQuery(container+' img').attr('src', '');
    jQuery(container).attr('data-foremove', 'true');
    jQuery(container).hide();
    if(hide){
        if(jQuery('#vssmp-image'+image_row_id).removeClass('element_image')){
        jQuery('#vssmp-image'+image_row_id).hide();
        }
        
    } 
    if(this_image.attr('checked') == 'checked'){
        var baseimg = jQuery('.element_image');
        if(baseimg.length > 0){
        jQuery.each(baseimg, function(id, val){
            if(id == 0){
              jQuery(val).find('.vssmp-txt-cntr.cell-image input').trigger('click');
              jQuery(val).find('.vssmp-txt-cntr.cell-small_image input').trigger('click');
              jQuery(val).find('.vssmp-txt-cntr.cell-thumbnail input').trigger('click'); 
              // jQuery(val).find('.vssmp-txt-cntr.cell-image input').attr('checked', 'checked');
              // jQuery(val).find('.vssmp-txt-cntr.cell-small_image input').attr('checked', 'checked');
              // jQuery(val).find('.vssmp-txt-cntr.cell-thumbnail input').attr('checked', 'checked');  
            }
        })
    }
    jQuery('#vssmp-image'+image_row_id).find('input').removeAttr('checked');
    //     console.log(jQuery('.element_image'))
    // console.log(this_image.attr('checked'));
    }
        show_10_image(); 
}

function drawVssmpSubProTable()
{
    sub_product_list_dt.fnDraw();
}

function drawVssmpRelProList()
{
    rel_product_list_dt.fnDraw();
}

function vssmpProcessRelatedSelect(e)
{
    var value = parseInt(jQuery(e).val());
    var index = jQuery.inArray(value, checked_related_products);
    if(jQuery(e).is(':checked')){
        if(index < 0){
            checked_related_products.push(value);
        }
    }else{
        if(index >= 0){
            checked_related_products.splice(index, 1);
        }
    }
    createRelatedProJson();
}

function createRelatedProJson()
{
    var selected_products = {};
    index = 0;
    for(index=0; index < checked_related_products.length; index++){
        selected_products[index] = checked_related_products[index];
    }

    jQuery('#vssmp_related_container input[name="product[rel_products]"]').attr('value', JSON.stringify(selected_products));
}

function vssmpProcessSubSelect(e)
{
    if(sub_product_parent == 'grouped'){
        var value = parseInt(jQuery(e).val());
        var index;
        if(jQuery(e).is(':checked')){
            if(checked_sub_products[value] == undefined){
                checked_sub_products[value] = [];
                checked_sub_products[value]['id'] = value;
                checked_sub_products[value]['qty'] = jQuery(e).parent().parent().find('input[name="group_pro_qty[]"]').val();
            }
        }else{
            if(checked_sub_products[value] != undefined){
                var tmp = [];
                for(index in checked_sub_products){
                    if(checked_sub_products[index]['id'] != undefined && checked_sub_products[index]['id'] != ''){
                        if(value != index){
                            tmp[index] = [];
                            tmp[index]['id'] = index;
                            tmp[index]['qty'] = checked_sub_products[index]['qty'];
                        }    
                    }
                }
                checked_sub_products = tmp;
            }
        }
    }else if(sub_product_parent == 'configurable'){
        var key = jQuery(e).attr('id');
        key = parseInt(key.replace('associate_',''));
        var index = jQuery.inArray(key, checked_sub_products);
        if(jQuery(e).is(':checked')){
            if(index < 0){
                if(!jQuery('#vssmp_associate_data input[name="product[sub_products]['+key+']"]').length){
                    var htm = "<input type='hidden' name='product[sub_products]["+key+"]' value='"+jQuery(e).val()+"' />";
                    jQuery('#vssmp_associate_data').append(htm);
                }
                checked_sub_products.push(key);
            }
            
        }else{
            if(index >= 0){
                if(jQuery('#vssmp_associate_data input[name="product[sub_products]['+key+']"]').length){
                    jQuery('#vssmp_associate_data input[name="product[sub_products]['+key+']"]').remove();
                }
                checked_sub_products.splice(index, 1);
            }
        }
    }
    createSubProductJson();
}

function createSubProductJson()
{
    
    var selected_products = {};
    if(sub_product_parent == 'grouped'){
        for(var key in checked_sub_products){
            if(checked_sub_products[key]['id'] != undefined && checked_sub_products[key]['id'] != ''){
                selected_products[key] = {'id' : checked_sub_products[key]['id'], 'qty': checked_sub_products[key]['qty']};    
            }
        }
        jQuery('#vssmp_associate_container input[name="product[sub_products]"]').attr('value', JSON.stringify(selected_products));
    }else if(sub_product_parent == 'configurable'){
        var index = 0;
        for(index=0; index < checked_sub_products.length; index++){
            selected_products[index] = checked_sub_products[index];
        }
        jQuery('#vssmp_associate_container input[name="sub_product_keys"]').attr('value', JSON.stringify(selected_products));
    }
}

function cancelProductEditing(redirect_url)
{
    var closeForm = confirm('Saved Data will be lost.\n Are you sure?');
    if(closeForm == true){
        window.location.href = redirect_url;
    }
}

function onUrlkeyChanged(url_key)
{
    if(jQuery('#'+url_key).val() == jQuery('#url_key_create_redirect_chk').val()){
        jQuery('#url_key_create_redirect_chk').attr('disabled', true);
        jQuery('#url_key_create_redirect_hid').attr('disabled', true);
    }else{
        jQuery('#url_key_create_redirect_chk').removeAttr('disabled');
        jQuery('#url_key_create_redirect_hid').removeAttr('disabled');
    }
}

function vssmpSaveAndContinue(e)
{
    // var allimage = jQuery('.vssmp-pro-img-preview');
    // var flag = 0;
    //     jQuery.each(allimage, function(id, val){
    //         if(jQuery(val).css('display') == 'none'){
    //             flag = 1;
    //             jQuery(val).parent().prepend('<h3 class="resqui" style="color:#bb2929;">Chose image or delete this block.</h3>');
    //         }
    //     });
    // if(flag == 0){      
    jQuery('#vssmp-product-form input[name="edit_mode"]').attr('value', 1);
    vssmpValidateForm(e);
        // } else {
        //     timer = setTimeout(function () {
        //             jQuery('.resqui').animate({opacity :  "0"} , 'slow',function() {
        //                 jQuery('.resqui').remove();
        //             });
        //             }, 2000);
        // }
}

function vssmpValidateForm(e)
{

    var allimage = jQuery('.vssmp-pro-img-preview');
    var flag = 0;
    jQuery.each(allimage, function(id, val){
    if(jQuery(val).css('display') == 'none' && jQuery(val).attr('data-foremove') != 'true'){
        flag = 1;
        jQuery(val).parent().prepend('<h3 class="resqui" style="color:#bb2929;">Chose image or delete this block.</h3>');
    }
});
    if(flag == 0){  
    var block_index = vssmp_form_block;
    vssmp_form_field_is_invalid = false;
    jQuery(e).parent().find('.vssmp_loading_16').css('display', 'inline-block');
    jQuery('#vssmp-product-form .vssmp-overlay').show();
    jQuery('#vssmp_glob_msg_content').hide();
    jQuery('#vssmp_glob_msg_content').html('');
    jQuery('#vssmp-product-form-inner input, #vssmp-product-form-inner select, #vssmp-product-form-inner textarea').removeClass('vssmp-hlyt-inv-field');
    jQuery('#vssmp-product-form-inner .validation_error_msg').remove();
    
    //basic block validations
    for(block_index = 0; block_index < vssmp_form_block.length; block_index++)
    {
        var blk_name = vssmp_form_block[block_index];
        if(jQuery('#vssmp-pro-form-blk-'+blk_name).length){
            jQuery('#vssmp-pro-form-blk-'+blk_name+ ' input[type="text"]').each(function(){
                vssmpProcessValidation(this);
            });
            jQuery('#vssmp-pro-form-blk-'+blk_name+ ' textarea').each(function(){
                vssmpProcessValidation(this);
            });
        }
    }
    
    //Images Block Validation
    if(jQuery('#vssmp-pro-form-blk-images input[type="text"]').length){
        jQuery('#vssmp-pro-form-blk-images input[type="text"]').each(function(){
            vssmpProcessValidation(this);
        });
    }
    
    //Downloadable Sample Validation
    if(jQuery('#vssmp-pro-form-blk-downloadable-sample tbody tr').length){
        jQuery('#vssmp-pro-form-blk-downloadable-sample tbody tr').each(function(){
            vssmpProcessValidation(jQuery(this).find('td:eq(0) input[type="text"]'));//title
            vssmpProcessValidation(jQuery(this).find('td:eq(2) input[type="text"]'));//sort order
            if(jQuery(this).find('td:eq(1) input[type="radio"]:checked').val() == 'file'){
                jQuery(this).find('td:eq(1) input[type="radio"]:checked').parent().addClass('vssmp-hlyt-inv-field');
            }else{
                vssmpProcessValidation(jQuery(this).find('td:eq(1) input[type="text"]'));//Url, if url is selected
            }
        });
    }
    
    //Downloadable Link Validation
    if(jQuery('#vssmp-pro-form-blk-downloadable-link tbody tr').length){
        jQuery('#vssmp-pro-form-blk-downloadable-link tbody tr').each(function(){
            vssmpProcessValidation(jQuery(this).find('td:eq(0) input[type="text"]'));//title
            vssmpProcessValidation(jQuery(this).find('td:eq(1) input[type="text"]'));//price
            if(!jQuery(this).find('td:eq(2) input[type="checkbox"]').is(':checked')){
                vssmpProcessValidation(jQuery(this).find('td:eq(2) input[type="text"]'));//max number of download
            }
            
            //Link Sample file validation
//            if(jQuery(this).find('td:eq(4) input[type="radio"]:checked').val() == 'file' && jQuery(this).find('td:eq(4) input[type="file"]').val() == ''){
//                jQuery(this).find('td:eq(4) input[type="radio"]:checked').parent().addClass('vssmp-hlyt-inv-field');
//            }else{
//                vssmpProcessValidation(jQuery(this).find('td:eq(4) input[type="text"]'));//Url, if url is selected
//            }
            
            if(jQuery(this).find('td:eq(5) input[type="radio"]:checked').val() == 'file'){
                jQuery(this).find('td:eq(5) input[type="radio"]:checked').parent().addClass('vssmp-hlyt-inv-field');
            }else{
                vssmpProcessValidation(jQuery(this).find('td:eq(5) input[type="text"]'));//Url, if url is selected
            }
            vssmpProcessValidation(jQuery(this).find('td:eq(6) input[type="text"]'));//sort order
        });
    }
    
    //Bundle Tab Validation
    if(jQuery('#vssmp-pro-form-blk-bundle .vssmp_bundle_option_blk').length){
        jQuery('#vssmp-pro-form-blk-bundle .vssmp_bundle_option_blk').each(function(){
            vssmpProcessValidation(jQuery(this).find('.vssmp_bundle_def_title_row input[type="text"]'));// Default Title
            vssmpProcessValidation(jQuery(this).find('.vssmp_bundle_type_sel_row input[type="text"]'));// Position
            if(jQuery(this).find('.vssmp_bundle_selected_pro_row tbody tr').length){
                jQuery(this).find('.vssmp_bundle_selected_pro_row tbody tr input[type="text"]').each(function(){
                    vssmpProcessValidation(jQuery(this));
                });
            }
            
        });
    }
    
    //Product New Dates Validation
    if(jQuery('input[name="product[news_from_date]"]').length 
            && jQuery('input[name="product[news_to_date]"]').length
            && jQuery('input[name="product[news_from_date]"]').val() != ''
            && jQuery('input[name="product[news_to_date]"]').val() != ''){
        var start_date = jQuery('input[name="product[news_from_date]"]').val();
        var end_date = jQuery('input[name="product[news_to_date]"]').val();
        if((new Date(start_date).getTime()) > (new Date(end_date).getTime())){
            jQuery('input[name="product[news_from_date]"]').addClass('vssmp-hlyt-inv-field');
            jQuery('input[name="product[news_to_date]"]').addClass('vssmp-hlyt-inv-field');
            jQuery('input[name="product[news_to_date]"]').parent().append('<span class="validation_error_msg">Past date not allowed</span>');
            vssmp_form_field_is_invalid = true;
        }
    }
    
    //Product Special Dates Validation
    if(jQuery('input[name="product[special_from_date]"]').length
            && jQuery('input[name="product[special_to_date]"]').length
            && jQuery('input[name="product[special_from_date]"]').val() != ''
            && jQuery('input[name="product[special_to_date]"]').val() != ''){
        var start_date = jQuery('input[name="product[special_from_date]"]').val();
        var end_date = jQuery('input[name="product[special_to_date]"]').val();
        if((new Date(start_date).getTime()) > (new Date(end_date).getTime())){
            jQuery('input[name="product[special_from_date]"]').addClass('vssmp-hlyt-inv-field');
            jQuery('input[name="product[special_to_date]"]').addClass('vssmp-hlyt-inv-field');
            jQuery('input[name="product[special_to_date]"]').parent().append('<span class="validation_error_msg">'+vssmp_invalid_date_msg+'</span>');
            vssmp_form_field_is_invalid = true;
        }
    }
    
    //Product Special Price Validation
    if(jQuery('input[name="product[price]"]').length
            && jQuery('input[name="product[special_price]"]').length
            && jQuery('input[name="product[price]"]').val() != ''
            && jQuery('input[name="product[special_price]"]').val() != ''){
        var price = jQuery('input[name="product[price]"]').val();
        var special_price = jQuery('input[name="product[special_price]"]').val();
        if(parseFloat(price) < parseFloat(special_price)){
            jQuery('input[name="product[price]"]').addClass('vssmp-hlyt-inv-field');
            jQuery('input[name="product[special_price]"]').addClass('vssmp-hlyt-inv-field');
            jQuery('input[name="product[special_price]"]').parent().append('<span class="validation_error_msg">'+vssmp_invalid_price_msg+'</span>');
            vssmp_form_field_is_invalid = true;
        }
    }
    
    if(vssmp_form_field_is_invalid){
        jQuery('#vssmp-product-form .vssmp-overlay').hide();
        jQuery(e).parent().find('.vssmp_loading_16').hide();
        jQuery('#vssmp_glob_msg_content').html(vssmp_invalid_form_message);
        jQuery('#vssmp_glob_msg_content').show();
        jQuery("html, body").animate({scrollTop:0}, '500');
        setTimeout(function(){ jQuery('#vssmp_glob_msg_content').hide(); }, 10000);
    }else{
        validateVssmpProductData(e);
    }   
        } else {
                timer = setTimeout(function () {
                        jQuery('.resqui').animate({opacity :  "0"} , 'slow',function() {
                            jQuery('.resqui').remove();
                        });
                        }, 2000);
            }
}

function vssmpProcessValidation(element)
{
    var isValid = true;
    var type = '';
    var value = jQuery(element).val();
    if(jQuery(element).hasClass('vssmp_req_field') && value == ''){
        vssmp_form_field_is_invalid = true;
        isValid = false;
    }else if(jQuery(element).hasClass('vssmp_req_field') && value != ''){
        type = getValidationType(element)
        if(type){
            isValid = vssmpValidateField(type, value);
            if(!isValid){
                vssmp_form_field_is_invalid = true;
            }
        }        
    }else if(!jQuery(element).hasClass('vssmp_req_field') && value != ''){
        type = getValidationType(element)
        if(type){
            isValid = vssmpValidateField(type, value);
            if(!isValid){
                vssmp_form_field_is_invalid = true;
            }
        }        
    }
    
    if(!isValid){
        jQuery(element).addClass('vssmp-hlyt-inv-field');
    }
}

function getValidationType(element){
    for(var i=0; i < vssmp_validation_types.length; i++){
        if(jQuery(element).hasClass('vssmp_validate_'+vssmp_validation_types[i])){
            return vssmp_validation_types[i];
        }
    }
    return false;
}

function vssmpValidateField(type,value){
    switch(type)
    {
        case 'int':{
                return numeric_reg.test(value);
        }
        case 'decimal':{
                return decimal_reg.test(value);
        }
        case 'date':{
                return date_reg.test(value);
        }
        case 'datetime':{
                return date_reg.test(value);
        }
        case 'text':{
                return text_reg.test(value);
        }
    }
    return true;
}

function vssmpCheckSkuExistence(elem)
{
    jQuery.ajax({
        url: vssmp_check_sku_url + (vssmp_check_sku_url.match(new RegExp('\\?')) ? '&isAjax=true' : '?isAjax=true'),
        type: 'POST',
        dataType: 'json',
        data: 'sku='+jQuery(elem).val()+'&product_id='+parseInt(vssmp_product_id),
        beforeSend: function() {

        },
        success: function(json) {
            if(json['error'] != undefined){
                jQuery(elem).addClass('vssmp-hlyt-inv-field');
                jQuery('#vssmp_glob_msg_content').html(json['error']);
                jQuery('#vssmp_glob_msg_content').show();
                jQuery("html, body").animate({scrollTop:0}, '500');
                setTimeout(function(){ jQuery('#vssmp_glob_msg_content').hide(); }, 10000);
            }else{
                //submitVssmpProductForm();
            }
        }
    });
}

function validateVssmpProductData(e)
{

    jQuery.ajax({
        url: vssmp_validate_action + (vssmp_validate_action.match(new RegExp('\\?')) ? '&isAjax=true' : '?isAjax=true'),
        type: 'POST',
        dataType: 'json',
        data: jQuery('form#vssmp-product-form-inner input, form#vssmp-product-form-inner input[type="checkbox"]:checked, form#vssmp-product-form-inner select, form#vssmp-product-form-inner textarea'),
        beforeSend: function() {

        },
        success: function(json) {
            if(json['error'] != undefined && json['error']){
                jQuery('#vssmp-product-form .vssmp-overlay').hide();
                jQuery(e).parent().find('.vssmp_loading_16').hide();
                jQuery('#vssmp_glob_msg_content').html(json['message']);
                jQuery('#vssmp_glob_msg_content').show();
                jQuery("html, body").animate({scrollTop:0}, '500');
                setTimeout(function(){ jQuery('#vssmp_glob_msg_content').hide(); }, 10000);
            }else if(json['error'] != undefined && !json['error']){
                submitVssmpProductForm();
            }
        }
    });
}



var sucmes = '<ul class="messages"><li class="success-msg"><ul><li><span>Profile has been saved successfully.</span></li></ul></li></ul>'


    function set_cookieAll(name, value, expires)
    {
        // document.cookie = name + "=" + value; +"path=/"; 
        // var date = new Date(new Date().getTime() + 60 * 1000);
document.cookie = 'coocsuc = <ul class="messages"><li class="success-msg"><ul><li><span>Profile has been saved successfully.</span></li></ul></li></ul>; path=/';
    };
//         function set_cookieAllError(name, value, expires)
//     {
//         // document.cookie = name + "=" + value; +"path=/"; 
//         // var date = new Date(new Date().getTime() + 60 * 1000);
// document.cookie = 'coocer = <ul class="messages"><li class="error-msg"><ul><li><span>Error. Sending data to the server failed</span></li></ul></li></ul>; path=/';
//     };




function submitVssmpProductForm()

{
// debugger;
    // var inputFileVal = jQuery("#vssmp-product-form-inner input[type=file]").val();
    var preloaderWrap = jQuery('.vssmp-overlay__wrap');
    var preloaderText = jQuery('.vssmp-overlay__text');
    var flagPreload = true;
jQuery('#vssmp-product-form-inner input[type=file]').each(function(){
// alert(jQuery(this).val());
if(jQuery(this).val()==''){
flagPreload = false;
console.log('flagPreload if'+flagPreload);

}
else{
flagPreload = true;
console.log('flagPreload else'+flagPreload);
return false;
// break;
}
 });

if(flagPreload == false){
preloaderWrap.css({
    'display': 'none'
});
preloaderText.css({
    'display': 'none'
});
vssmpNoAjax();

}
else{
    preloaderWrap.css({
    'display': 'block'
});
preloaderText.css({
    'display': 'block'
});
vssmpAjax();
// vssmpNoAjax();

}




function vssmpAjax(){
console.log('go!');
jQuery('.vssmp-overlay').css({
'display': 'block'
});

    var stat = jQuery('.vssmp-overlay__stat');
    var span = jQuery('.vssmp-overlay__stat span');
    var anim = jQuery('.vssmp-overlay__stat__anim');
    stat.css({
'width': '0'
});
// animate
    function StatAnimateInterval() {
        StatAnimating();
        statAnim = setInterval(StatAnimating, 2500);
    };

    function StatAnimating() {
        anim.animate({
            marginLeft: "-=30px"
        }, 2500, "linear").append('/');
        console.log('wipoln');
    };
    // animate



anim.text('////////////////////////');
StatAnimateInterval();
                    // e.preventDefault();
        var $that = jQuery('#vssmp-product-form-inner');
        // var $that = jQuery(this);
console.log($that.attr('action'));
console.log($that.attr('method'));

                formData = new FormData($that.get(0));
        jQuery.ajax({
            url: $that.attr('action'),
            type: $that.attr('method'),
            contentType: false,
            processData: false,
            data: formData,
            // data: data,
            //dataType: 'json',
            beforeSend: function(){
                stat.css({
                    'width': '0'
                });
            },
            
            
            xhr: function(){

                
                
                
                                var xhr = jQuery.ajaxSettings.xhr(); // получаем объект XMLHttpRequest
                xhr.upload.addEventListener('progress', function(evt){ // добавляем обработчик события progress (onprogress)
                    if (evt.lengthComputable) { // если известно количество байт
                        console.log(evt.lengthComputable);
                        // высчитываем процент загруженного
                        var percentComplete = Math.ceil(evt.loaded / evt.total * 62);
                    if(percentComplete<62){

                        console.log('процент загрузки:'+percentComplete);

                        // устанавливаем значение в атрибут value тега progress
                        // и это же значение альтернативным текстом для браузеров, не поддерживающих &lt;progress&gt;
                        // progressBar.val(percentComplete).text('Загружено ' + percentComplete + '%');
                        // perc.val(percentComplete);
                        stat.css({
                            'width': percentComplete+'%'
                            
                        });
                        console.log(stat.width());


                        span.text(percentComplete+'%');
                        
                    }
                    else{
                        console.log('хватит пока');


 var i=62;

 
after60=function(){

   // тело цикла
   span.text(i+'%');
stat.css({
'width': i+'%'
});
 
   // счётчик и условие исполнения цикла  
   i=i+1; if (i<96) setTimeout(after60, "210");
};
 
after60();

}





                    }
                
                    else{
                        console.log('количество байт не известно');
                    }
                }, false);
                return xhr;
            },
            
            success: function(json){

                console.log('ok!')
                //if(json){
                    //$that.after(json);
                //}




    set_cookieAll();
// set_cookieAllError();




            },
                  error: function (jqXhr, textStatus, errorThrown) {
// set_cookieAllError();
    // set_cookieAll();


                      console.log("Ошибка '" + jqXhr.status + "' (textStatus: '" + textStatus + "', errorThrown: '" + errorThrown + "')");
                  },
                  complete: function () {

var j=97;
 clearTimeout(after60);
 
after97=function(){
 
   // тело цикла
   span.text(j+'%');
stat.css({
'width': j+'%'
});
 
   // счётчик и условие исполнения цикла  
   j=j+1; if (j<=100) setTimeout(after97, "100");
};
after97();

clearInterval(statAnim);
jQuery('.vssmp-overlay__text').html('Uploaded');

var timeout = setTimeout(function(){
jQuery('.vssmp-overlay__text').html('Uploading...');

    jQuery('.vssmp-overlay').css({
'display': 'none'
});
   stat.css({
                            'width': '0%'
                            
                        });
                        span.text('0%'); 
}, 800);

var timeout2 = setTimeout(function(){

if(flagSubmit){
// location.reload(true);
    window.location.href = "<?php echo $prourl; ?>";

}
else if(!flagSubmit){
  
    window.location.href = jQuery.trim(jQuery('#currentproducturl').html());
}
}, 1000);





                  }

        });














        
    //     e.preventDefault();
    //     var form = $(this);
    //     var url=form.attr('action');   
    //     console.log(url); 
    //     // объект формы(он в себя собирает все поля и  файлы)
    //     var formData = new FormData(form[0]);    // Значение нуль в скобках обязательно 
    //     $.ajax({
    //         url: url,
    //         type: "POST",
    //         //data: form.serialize(),
    // processData: false,
    // contentType: false,

    //         data:  formData,
    //         success: function (result) {             
    //            console.log('ok');
            
    //         }
    //     });


    // });

    // jQuery('#vssmp-product-form-inner').submit();





}

function vssmpNoAjax(){
    jQuery('#vssmp-product-form-inner').submit();

}
}




//////////////////////////// Start - Pop up Window ///////////////////////////////////

function createEmptySimpleProduct(url)
{
    if (this.win && !this.win.closed) {
            this.win.close();
    }

    this.win = window.open(url, '',
            'width=1000,height=700,resizable=1,scrollbars=1');
    this.win.focus();
}

function closeSimpleProductPopup()
{
    window.close();
    sub_product_list_dt.fnDraw();
    rel_product_list_dt.fnDraw();
}
//////////////////////////// End - Pop up Window ///////////////////////////////////

/////////////////////////// Start - Quick Create Product //////////////////////////////////////////
function vssmpCreateQuickProduct(url)
{
    var error = false;
    jQuery('#vssmp-simple-product-popup input[type="text"]').each(function(){
        //vssmpProcessValidation(this);
        var isValid = true;
        var type = '';
        var value = jQuery(this).val();
        if(jQuery(this).hasClass('vssmp_req_field') && value == ''){
            error = true;
            isValid = false;
        }else if(jQuery(this).hasClass('vssmp_req_field') && value != ''){
            type = getValidationType(this)
            if(type){
                isValid = vssmpValidateField(type, value);
                if(!isValid){
                    error = true;
                }
            }        
        }else if(!jQuery(this).hasClass('vssmp_req_field') && value != ''){
            type = getValidationType(this)
            if(type){
                isValid = vssmpValidateField(type, value);
                if(!isValid){
                    error = true;
                }
            }        
        }
        
        if(!isValid){
            jQuery(this).addClass('vssmp-hlyt-inv-field');
        }
    });
    
    if(error){
        jQuery('#vssmp-simple-product-popup .vssmp-glob-warning').html(vssmp_invalid_form_message);
        jQuery('#vssmp-simple-product-popup .vssmp-glob-warning').show();
        jQuery("#vssmp-simple-product-popup .vssmp-map-popup-content").animate({scrollTop:0}, '500');
    }else{
        jQuery.ajax({
            url: url + (url.match(new RegExp('\\?')) ? '&isAjax=true' : '?isAjax=true'),
            type: 'POST',
            dataType: 'json',
            data: jQuery('#vssmp-simple-product-popup input, #vssmp-simple-product-popup select, #vssmp-simple-product-popup textarea'),
            beforeSend: function() {
                    jQuery('#vssmp-simple-product-popup #vssmp-quick-pro-save-progress').css('display','inline-block');
            },
            success: function(json) {
                if(json['success'] != undefined){
                    jQuery('#vssmp-simple-product-popup #vssmp-quick-pro-save-progress').hide();
                    closeModalAfterReset('vssmp-simple-product-popup');
                    jQuery('#vssmp-simple-product-popup input[type="text"]').attr('value', '');
                    jQuery('#vssmp-simple-product-popup select option').removeAttr('selected');
                    jQuery('#vssmp-simple-product-popup textarea').html('');
                    jQuery('#vssmp-simple-product-popup .vssmp-glob-warning').html('');
                    if(sub_product_list_dt != ''){
                        sub_product_list_dt.fnDraw();
                    }
                    if(rel_product_list_dt != ''){
                        rel_product_list_dt.fnDraw();
                    }
                }else{
                    var msg = 'Technical Error';
                    if(json['error'] != undefined){
                        msg = json['error']['message'];
                    }
                    jQuery('#vssmp-simple-product-popup #vssmp-quick-pro-save-progress').hide();
                    jQuery('#vssmp-simple-product-popup .vssmp-glob-warning').html(msg);
                    jQuery('#vssmp-simple-product-popup .vssmp-glob-warning').show();
                    jQuery("#vssmp-simple-product-popup .vssmp-map-popup-content").animate({scrollTop:0}, '500');
                }
            }
        });
    }
}



/////////////////////////// Start - Quick Create Product //////////////////////////////////////////




jQuery(function(){


jQuery('.js-vssmpSaveAndContinue').unbind('click').click(function(){
   // submitVssmpProductForm();
   flagSubmit = true;
    vssmpSaveAndContinue();
});
jQuery('.js-vssmpValidateForm').unbind('click').click(function(){
   flagSubmit = false;
    vssmpValidateForm();
});
// jQuery('body').on('click', '.js-vssmpSaveAndContinue', function(){
//    // submitVssmpProductForm();
//    flagSubmit = true;
//     vssmpSaveAndContinue();
// });
// jQuery('body').on('click', '.js-vssmpValidateForm', function(){
//    // submitVssmpProductForm();
//    flagSubmit = false;
//     vssmpValidateForm();
// });










});
