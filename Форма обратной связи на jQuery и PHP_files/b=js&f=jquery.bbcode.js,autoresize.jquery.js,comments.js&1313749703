(function($){$.fn.bbcode=function(options){var options=$.extend({tag_bold:false,tag_code:true,tag_italic:false,tag_underline:false,tag_link:false,tag_image:false,button_image:false,image_url:'css/images/bbimage/'},options||{});var text='<div id="bbcode_bb_bar">'
if(options.tag_bold){text=text+'<a href="#" id="b" title="">';if(options.button_image){text=text+'<img src="'+options.image_url+'bold.png" />';}else{text=text+'Bold';}
text=text+'</a>';}
if(options.tag_code){text=text+'<a href="#" id="code" title="">';if(options.button_image){text=text+'<img src="'+options.image_url+'code.png" />';}else{text=text+'[CODE][/CODE]';}
text=text+'</a>';}
if(options.tag_italic){text=text+'<a href="#" id="i" title="">';if(options.button_image){text=text+'<img src="'+options.image_url+'italic.png" />';}else{text=text+'Italic';}
text=text+'</a>';}
if(options.tag_underline){text=text+'<a href="#" id="u" title="">';if(options.button_image){text=text+'<img src="'+options.image_url+'underline.png" />';}else{text=text+'Undescore';}
text=text+'</a>';}
if(options.tag_link){text=text+'<a href="#" id="url" title="">';if(options.button_image){text=text+'<img src="'+options.image_url+'link.png" />';}else{text=text+'Link';}
text=text+'</a>';}
if(options.tag_image){text=text+'<a href="#" id="img" title="">';if(options.button_image){text=text+'<img src="'+options.image_url+'image.png" />';}else{text=text+'Image';}
text=text+'</a>';}
text=text+'</div>';$(this).wrap('<div id="bbcode_container"></div>');$("#bbcode_container").prepend(text);$("#bbcode_bb_bar a img").css("border","none");var id='#'+$(this).attr("id");var e=$(id).get(0);$('#bbcode_bb_bar a').click(function(){var button_id=$(this).attr("id");var start='['+button_id+']';var end='[/'+button_id+']';var param="";if(button_id=='img')
{param=prompt("Enter image URL","http://");if(param)
start+=param;}
else if(button_id=='url')
{param=prompt("Enter URL","http://");if(param)
start='[url href='+param+']';}
insert(start,end,e);return false;});}
function insert(start,end,element){if(document.selection){element.focus();sel=document.selection.createRange();sel.text=start+sel.text+end;}else if(element.selectionStart||element.selectionStart=='0'){element.focus();var startPos=element.selectionStart;var endPos=element.selectionEnd;element.value=element.value.substring(0,startPos)+start+element.value.substring(startPos,endPos)+end+element.value.substring(endPos,element.value.length);}else{element.value+=start+end;}}
$(document).keyup(function(e)
{if(e.which==17)isCtrl=false;}).keydown(function(e)
{if(e.which==17)isCtrl=true;})})(jQuery)
;(function($){$.fn.autoResize=function(options){var settings=$.extend({onResize:function(){},animate:true,animateDuration:150,animateCallback:function(){},extraSpace:20,limit:1000},options);this.filter('textarea').each(function(){var textarea=$(this).css({'overflow-y':'hidden'}),origHeight=textarea.height(),clone=(function(){var props=['height','width','lineHeight','textDecoration','letterSpacing'],propOb={};$.each(props,function(i,prop){propOb[prop]=textarea.css(prop);});return textarea.clone().removeAttr('id').removeAttr('name').css({position:'absolute',top:0,left:-9999}).css(propOb).attr('tabIndex','-1').insertBefore(textarea);})(),lastScrollTop=null,updateSize=function(){if($.browser.msie&&$.browser.version==6){var obj=jQuery(this).get(0);var m=obj.createTextRange().boundingHeight;if(m<origHeight)m=origHeight;m+=settings.extraSpace;jQuery(this).css("height",m+'px');}
else{clone.height(0).val($(this).val()).scrollTop(10000);var scrollTop=Math.max(clone.scrollTop(),origHeight)+settings.extraSpace,toChange=$(this).add(clone);if(lastScrollTop===scrollTop){return;}
lastScrollTop=scrollTop;if(scrollTop>=settings.limit){$(this).css('overflow-y','');return;}
settings.onResize.call(this);settings.animate&&textarea.css('display')==='block'?toChange.stop().animate({height:scrollTop},settings.animateDuration,settings.animateCallback):toChange.height(scrollTop);}};textarea.unbind('.dynSiz').bind('keyup.dynSiz',updateSize).bind('keydown.dynSiz',updateSize).bind('change.dynSiz',updateSize);});return this;};})(jQuery);
;$(function(){var editComment=0;$('#addNewComment').click(function(){commentForm(0);return false});$('#comment li .reply').click(function(){var parentComm=$(this).parents('li').attr('id');commentForm(parentComm);return false});$('#comment li .edit_comment').live('click',function(){var commObj=$(this).parent().parent();editComment=commObj.attr('id');commentToForm(commObj);});$('.saveComment').live('click',function(){var btn=$(this);btn.hide().next().show();$.ajax({data:{senddata:$('.newComment #formComment').serializeArray(),type:3,edit:editComment},success:function(data){if(data.errors){$('.newComment .error').text(data.errors).fadeIn('fast').delay(5000).fadeOut('fast');btn.show().next().hide();}
else
{$('.newComment .error').remove();formToComment(data.success);var commentCount=$('#commentCount span').text();commentCount=parseInt(commentCount,10);commentCount++;$('#commentCount span').text(commentCount);editComment=0;}}});});function commentForm(parentComment){if($('.newComment').length)$('.newComment').remove();var cloneForm=$('#newComment').clone();cloneForm.removeAttr('id').addClass('newComment');if(!parentComment)$('#newComment').before(cloneForm);else{cloneForm.find('input').val(parentComment);if(!$('#'+parentComment).children('ul').length)
$('#'+parentComment).append('<ul></ul>');$('#'+parentComment).children('ul').append(cloneForm);}
var textarea=cloneForm.find('textarea');textarea.bbcode();textarea.css('font-size','14px').autoResize({extraSpace:0});var position=cloneForm.offset().top-100;$("html:not(:animated)"+(!$.browser.opera?",body:not(:animated)":"")).animate({scrollTop:position},'1500',function(){textarea.delay('1000').trigger('focus');});cloneForm.find('.cancelComment').click(function(){var obj=$(this).parents('li.newComment');obj.remove();return false;});$('#comment').data('cloneForm',cloneForm);}
function commentToForm(commObj){if($('.newComment').length)$('.newComment').remove();var text=commObj.find('.p').html();text=text.replace(/\<pre\>/g,'[code]');text=text.replace(/\<\/pre\>/g,'[/code]');text=text.replace(/\<br \/\>/g,'\n');text=text.replace(/\<br\>/g,'\n');text=htmlspecialchars_decode(text,'ENT_QUOTES');var cloneForm=$('#newComment').clone();cloneForm.removeAttr('id').addClass('newComment');commObj.before(cloneForm);var oldComm=commObj.detach();var textarea=cloneForm.find('textarea');textarea.text(text);textarea.bbcode();textarea.css('font-size','14px').autoResize({extraSpace:0});cloneForm.find('.cancelComment').click(function(){cloneForm.before(oldComm);cloneForm.remove();return false;});$('#comment').data('cloneForm',cloneForm);}
function formToComment(id){var date_add="менее минуты назад";obj=$('#comment').data('cloneForm');obj.removeClass('newComment').attr('id','comm'+id);obj.find('.saveComment, .loader, .CommentButton, input').remove();obj.find('small').text(date_add);var nic=$('#user').children().children('h3').text();obj.find('h6').text(nic);obj.find('textarea').unwrap('<form id = "formComment"></form>');var text=obj.find('textarea').val();text=htmlspecialchars(text);text=text.replace(/\[code\]/g,'<pre>');text=text.replace(/\[\/code\]/g,'</pre>');text=text.replace(/\n/g,'<br />');obj.find('.commentAdd').after('<img title="Редактировать" class="edit_comment" src="css/images/comment_edit.png"><div class="clear"></div>')
obj.find('.commentAdd').replaceWith('<div class = "p">'+text+'</div>');var contrnt=obj.find('#formComment').html();obj.find('#formComment').parent().append(contrnt);obj.find('#formComment').remove();}});function htmlspecialchars_decode(string,quote_style){var optTemp=0,i=0,noquotes=false;if(typeof quote_style==='undefined'){quote_style=2;}
string=string.replace(/&lt;/g,'<').replace(/&amp;lt;/g,'<').replace(/&gt;/g,'>').replace(/&amp;gt;/g,'>');var OPTS={'ENT_NOQUOTES':0,'ENT_HTML_QUOTE_SINGLE':1,'ENT_HTML_QUOTE_DOUBLE':2,'ENT_COMPAT':2,'ENT_QUOTES':3,'ENT_IGNORE':4};if(quote_style===0){noquotes=true;}
if(typeof quote_style!=='number'){quote_style=[].concat(quote_style);for(i=0;i<quote_style.length;i++){if(OPTS[quote_style[i]]===0){noquotes=true;}
else if(OPTS[quote_style[i]]){optTemp=optTemp|OPTS[quote_style[i]];}}
quote_style=optTemp;}
if(quote_style&OPTS.ENT_HTML_QUOTE_SINGLE){string=string.replace(/&#0*39;/g,"'");}
if(!noquotes){string=string.replace(/&quot;/g,'"');}
string=string.replace(/&amp;/g,'&');return string;}