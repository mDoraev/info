!function(){HC.SHA1=function(){function a(a){return e(f(d(a),8*a.length))}function b(a){var b,c="";for(var d in a)b=a.charCodeAt(d),c+=(b>>4&15).toString(16)+(15&b).toString(16);return c}function c(a){for(var b,c,d="",e=-1;++e<a.length;)b=a.charCodeAt(e),c=e+1<a.length?a.charCodeAt(e+1):0,b>=55296&&56319>=b&&c>=56320&&57343>=c&&(b=65536+((1023&b)<<10)+(1023&c),e++),127>=b?d+=k(b):2047>=b?d+=k(192|b>>6&31,128|63&b):65535>=b?d+=k(224|b>>12&15,128|b>>6&63,128|63&b):2097151>=b&&(d+=k(240|b>>18&7,128|b>>12&63,128|b>>6&63,128|63&b));return d}function d(a){for(var b=[],c=0;c<8*a.length;c+=8)b[c>>5]|=(255&a.charCodeAt(c/8))<<24-c%32;return b}function e(a){for(var b="",c=0;c<32*a.length;c+=8)b+=k(a[c>>5]>>24-c%32&255);return b}function f(a,b){a[b>>5]|=128<<24-b%32,a[(b+64>>9<<4)+15]=b;for(var c=[],d=1732584193,e=-271733879,f=-1732584194,k=271733878,l=-1009589776,m=0;m<a.length;m+=16){for(var n=d,o=e,p=f,q=k,r=l,s=0;80>s;s++){16>s?c[s]=a[m+s]:c[s]=j(c[s-3]^c[s-8]^c[s-14]^c[s-16],1);var t=i(i(j(d,5),g(s,e,f,k)),i(i(l,c[s]),h(s)));l=k,k=f,f=j(e,30),e=d,d=t}d=i(d,n),e=i(e,o),f=i(f,p),k=i(k,q),l=i(l,r)}return[d,e,f,k,l]}function g(a,b,c,d){return 20>a?b&c|~b&d:40>a?b^c^d:60>a?b&c|b&d|c&d:b^c^d}function h(a){return 20>a?1518500249:40>a?1859775393:60>a?-1894007588:-899497514}function i(a,b){var c=(65535&a)+(65535&b),d=(a>>16)+(b>>16)+(c>>16);return d<<16|65535&c}function j(a,b){return a<<b|a>>>32-b}var k=String.fromCharCode;return function(d){return b(a(c(d)))}}()}(),function(a,b){HC.LSH=function(a){this.hash=this.hashCreate(a)},HC.LSH.prototype={hashCreate:function(a){var b,c=HC.LSH._split(a),d=[[],[],[],[]];for(b=0;b<c.length;b++)for(var e=HC.SHA1(c[b]),f=HC.LSH._to32Bits(e),g=0;g<f.length;g++)d[g].push(f[g]);var h=[];for(b=0;b<d.length;b++)h.push(HC.LSH._toHexString(HC.LSH._minHash(d[b])));return h.join("").replace("0000","")}},HC.LSH.similar=function(a,b){for(var c,d,e=HC.LSH._to32Bits(a),f=HC.LSH._to32Bits(b),g=[],h=[],i=0;i<e.length;i++)g.push((e[i]&f[i])>>>0),h.push((e[i]|f[i])>>>0);return c=HC.LSH._hammingDistance(HC.LSH._arrayToHexString(g)),d=HC.LSH._hammingDistance(HC.LSH._arrayToHexString(h)),0===d?0:c/d},HC.LSH._hammingDistance=function(a){for(var b=0,c=HC.LSH._to32Bits(a),d=0;d<c.length;d++){var e,f=c[d];for(e=0;f;e++)f&=f-1;b+=e}return b},HC.LSH._split=function(a){if(!a)return[""];var b=/[\s\-=_!"#%&'*{},.\/:;?\(\)\[\]@\\$\^*+<>~`\u00a1\u00a7\u00b6\u00b7\u00bf\u037e\u0387\u055a-\u055f\u0589\u05c0\u05c3\u05c6\u05f3\u05f4\u0609\u060a\u060c\u060d\u061b\u061e\u061f\u066a-\u066d\u06d4\u0700-\u070d\u07f7-\u07f9\u0830-\u083e\u085e\u0964\u0965\u0970\u0af0\u0df4\u0e4f\u0e5a\u0e5b\u0f04-\u0f12\u0f14\u0f85\u0fd0-\u0fd4\u0fd9\u0fda\u104a-\u104f\u10fb\u1360-\u1368\u166d\u166e\u16eb-\u16ed\u1735\u1736\u17d4-\u17d6\u17d8-\u17da\u1800-\u1805\u1807-\u180a\u1944\u1945\u1a1e\u1a1f\u1aa0-\u1aa6\u1aa8-\u1aad\u1b5a-\u1b60\u1bfc-\u1bff\u1c3b-\u1c3f\u1c7e\u1c7f\u1cc0-\u1cc7\u1cd3\u2016\u2017\u2020-\u2027\u2030-\u2038\u203b-\u203e\u2041-\u2043\u2047-\u2051\u2053\u2055-\u205e\u2cf9-\u2cfc\u2cfe\u2cff\u2d70\u2e00\u2e01\u2e06-\u2e08\u2e0b\u2e0e-\u2e16\u2e18\u2e19\u2e1b\u2e1e\u2e1f\u2e2a-\u2e2e\u2e30-\u2e39\u3001-\u3003\u303d\u30fb\ua4fe\ua4ff\ua60d-\ua60f\ua673\ua67e\ua6f2-\ua6f7\ua874-\ua877\ua8ce\ua8cf\ua8f8-\ua8fa\ua92e\ua92f\ua95f\ua9c1-\ua9cd\ua9de\ua9df\uaa5c-\uaa5f\uaade\uaadf\uaaf0\uaaf1\uabeb\ufe10-\ufe16\ufe19\ufe30\ufe45\ufe46\ufe49-\ufe4c\ufe50-\ufe52\ufe54-\ufe57\ufe5f-\ufe61\ufe68\ufe6a\ufe6b\uff01-\uff03\uff05-\uff07\uff0a\uff0c\uff0e\uff0f\uff1a\uff1b\uff1f\uff20\uff3c\uff61\uff64\uff65]+/g,c=a.replace(b," ").replace(/[\s\xa0]+/g," ").replace(/^\s+|\s+$/g,"").toLowerCase();return c.split(" ")},HC.LSH._toHexString=function(a){for(var b=a.toString(16),c=8-b.length,d=[],e=0;c>e;e++)d.push("0");return d.join("")+b},HC.LSH._arrayToHexString=function(a){for(var b=[],c=0;4>c;c++)b.push(HC.LSH._toHexString(a[c]));return b.join("")},HC.LSH._to32Bits=function(a){if(!a)return null;for(var b=32,c=8,d=[],e=0;b>e;e+=c){var f=b>e+c?a.slice(e,e+c):a.slice(e);d.push(parseInt(f,16))}return d},HC.LSH._minHash=function(a){for(var b,c=0,d=1,e=0;32>e;e++){for(var f=0,g=0;g<a.length;g++)b=a[g],f+=b&d?1:-1;f>0&&(c|=d),d<<=1}return c>>>0}}(this.jHC,this.underscoreHC),function(a,b){HC.HyperText=function(a,c){this.opt=b.extend(HC.HyperText.def_opt,a),this.app=c,this.init(),new HC.HyperText.View(c)},HC.HyperText.def_opt={hypertext:"*",ignored:"",rootEl:"hcc",regexp:"[^\\s,;:–.!?()<>…\\n \\*]+",is_block:function(b){return"BR"==b.nodeName||-1==a.inArray(a(b).css("display"),["inline","none"])},clikerClass:".e_hcliker",popupClass:".e_htpopup",highlight:".e_hchl"},HC.HyperText.prototype={clikerEl:null,init:function(){this.selectableNode="*"==this.opt.hypertext?document.body:a(this.opt.hypertext)[0],this.isIgnore=this.ignoreContruct(this.opt.ignored),this.range=null,this.selText=null,this.selFixText=null,this.htID=null,this.htCont=null,this.hashStore={},this.counterPopups=0,this.app.IO.on("streamMessage",this.streamMessage,this),this.app.IO.on("streamDeleteMessage",this.streamDelete,this),this.app.IO.on("streamSpamMessage",this.streamDelete,this),this.app.IO.on("packets",this.packets,this),this.enumerateElements(),this.loadHypertext(),a(this.selectableNode).on("mouseup",this.showCliker.bind(this))},loadHypertext:function(){this.app.m.Settings||(this.app.m.Settings=new HC.M.Settings(this.app.config),this.app.m.UserAuth=new HC.M.UserAuth,this.app.m.StreamInfo=new HC.M.StreamInfo);var a=this.app.m.Settings,b={stream:"streamstart",widget_id:a.get("widget_id"),href:a.get("href"),xid:a.get("xid"),auth:a.get("auth"),title:a.get("title")},c=function(b){this.app.m.UserAuth.set(b.data[0]);var c=b.data[1].hypertext;this.app.m.StreamInfo.setParams(b.data[1]),this.app.IO.settings.stream_id=this.app.m.StreamInfo.get("id"),this.app.IO.settings.widget_id=a.get("widget_id"),this.app.IO.settings.auth=a.get("auth"),c&&this.findHash(c)}.bind(this);this.app.IO.api("/hypertext",b,function(a){c(a)}.bind(this))},findHash:function(a){function c(){try{if(a.length!=e.length)return;d.length&&f.findSimilarHash(d),clearInterval(g),f.setOverEvent()}catch(b){clearInterval(g),HC.log("[ERROR] render HT hash:",b.message)}}var d=[],e=[],f=this;b.each(a,function(a){b.defer(function(){var b=this.hashStore[a.hypertext_id];b?(b.find("span").html(a.cm),b.show()):d.push(a),e.push(a)}.bind(this))},this);var g=setInterval(c,100)},setOverEvent:function(){var b=a(this.selectableNode).find(".hc__ht").filter(function(){return"none"===a(this).css("display")}).parent();b.on("mouseover",function(){a(this).find(".hc__ht").show()}).on("mouseout",function(){a(this).find(".hc__ht").hide()})},findSimilarHash:function(a){b.each(a,function(a){b.defer(function(){this._similarHt(a)}.bind(this))},this)},_similarHt:function(c){var d=b.keys(this.hashStore);b.each(d,function(d){b.defer(function(){if(HC.LSH.similar(d,c.hypertext_id)>.65){a('[data-hc-id="'+d+'"]').attr("data-hc-id",c);var b=this.hashStore[d];b.find("span").html(c.cm)}}.bind(this))},this)},enumerateElements:function(){function a(b){if(b){for(var e=b.childNodes,f=!1,g=!1,h=0,i=e.length;i>h;++h){var j=e.item(h),k=j.nodeType,l=j.nodeValue;if(3!=k||l.match(c))if(3==k){if(g)continue;d.canSelect(j.parentNode,l)&&d.addHash(j.parentNode,l),f=g=!0,h++}else if(1==k){if(d.isIgnore(j))continue;var m=d.opt.is_block(j);if(m){var n=a(j);f=f||n,g=!1}else g||(g=a(j),f=f||g)}}return f}}var b=this.selectableNode,c=this.opt.regexp,d=this;a(b)},canSelect:function(a,b){var c="*"==this.opt.hypertext?!0:!1;if(!c)return!0;var d=b.split(" ").length;return("P"==a.tagName||"DIV"==a.tagName)&&d>3?!0:!1},ignoreContruct:function(b){var c=b?b.split(","):[],d=[],e=[],f=[];e.push(this.opt.rootEl);for(var g=0;g<c.length;g++){var h=a.trim(c[g]);"#"==h.charAt(0)?d.push(h.substr(1)):"."==h.charAt(0)?e.push(h.substr(1)):f.push(h)}return function(b){var c;for(c=d.length;c--;)if(b.id==d[c])return!0;for(c=e.length;c--;)if(a(b).hasClass(e[c]))return!0;for(c=f.length;c--;)if(b.tagName==f[c].toUpperCase())return!0;return!1}},addHash:function(b,c){if(!a(b).attr("data-hc-id")){var d=new HC.LSH(c);a(b).attr("data-hc-id",d.hash);var e=HC.$tmpl("HTIcon",{hash:d.hash});a(b).append(e.hide()),this.hashStore[d.hash]=e,e.on("click",this.showPopup.bind(this))}},showCliker:function(c){var d,e,f=this.getSel(),g=-80,h=5;return f.length&&f!=this.selText?(this.selText=f,c.type&&"mouseup"==c.type?(g+=c.pageX,h+=c.pageY):(e=c.originalEvent.touches[0]||c.originalEvent.changedTouches[0],g+=e.pageX,h+=e.pageY),this.clikerEl?this.clikerEl.css({top:h,left:g}):(d=HC.$tmpl("HTCliker",{hash:this.htID}),this.clikerEl=d,this.clikerEl.css({top:h,left:g}),a("body").append(d),b.delay(function(){d.attr("active",!0)}.bind(this),10),b.delay(function(){d.attr("scale",!0)}.bind(this),100),b.delay(function(){d.removeAttr("scale")}.bind(this),200)),a(this.clikerEl).find("[el=Comment]").on("click",this.showPopup.bind(this)),void a(this.clikerEl).find("[rel=Share]").on("click",this.share.bind(this))):void this.removeClicker()},removeClicker:function(){a(this.opt.clikerClass).removeAttr("active"),a(this.opt.clikerClass).removeAttr("scale"),b.delay(function(){a(this.opt.clikerClass).remove()}.bind(this),150),this.clikerEl=null},showPopup:function(c){if(!a(c.currentTarget).attr("active")){var d=a(c.currentTarget).attr("data-hc-id");d&&(this.htID=d,this.htCont=a(c.currentTarget).parent(),this.selText=null,this.selFixText=null,this.range=null),this.removeClicker(),a('[data-hc-id="'+this.htID+'"]').attr("active",!0),this.range&&this.range.surroundContents(HC.$tmpl("HThighlight",{hypertext_color:this.app.m.Settings.get("hypertext_color")})[0]);var e,f=new HC.V.HT({selText:this.selFixText,htID:this.htID,model:this.app.m.Settings,auth:this.app.m.UserAuth,info:this.app.m.StreamInfo,collection:new HC.C.CommentCollection([],{ht:!0})}),g=.7*this.htCont.width(),h=a(window).width();450>h?(g=h-52,e=5):(g=400>g?400:g>620?620:.7*this.htCont.width(),e=this.htCont.offset().left+(this.htCont.width()-g)/2),a("body").append(f.$el),f.$el.css({top:this.htCont.offset().top+this.htCont.height(),left:e,width:g}),this.counterPopups++,b.delay(function(){f.$el.attr("active",!0)}.bind(this),10),f.Trgl.css("left",g/2-10),this._scrollToForm(f.$el),HC.Utils.unClick(function(){f.$el.removeAttr("active",!0),b.delay(function(){f.destroy(),this.counterPopups--,HC.isRender||0!==this.counterPopups||this.app.IO.close("hard")}.bind(this),400),this.unwrap(a(this.opt.highlight)[0]),a(".hc__ht").removeAttr("active",!0)}.bind(this),"hc_"+this.htID,"e__hc__popup")}},_scrollToForm:function(b){var c=window.pageYOffset||a(window).scrollTop(),d=a(window).height(),e=b.offset().top,f=e-d+200;e>c+d-200&&HC.Utils.scrollWorker(f)},getSel:function(){var b=window.getSelection(),c=b.toString();if(0===c.length)return"";var d=b.rangeCount?b.getRangeAt(0):null,e=this.findHtId(a(d.startContainer.parentNode),0),f=this.findHtId(a(d.endContainer.parentNode),0);if(!e||!f)return"";var g=e.attr("data-hc-id"),h=f.attr("data-hc-id");return g!=h?"":(this.checkPosition(d,d.startOffset,d.startContainer,"start"),this.checkPosition(d,d.endOffset,d.endContainer,"end"),this.selFixText=d.toString().replace(/^\s*/,"").replace(/\s*$/,"").replace(/\n*/g,"").replace(/\s+/," "),this.selFixText.length>150&&(this.selFixText=this.selFixText.substring(0,150)+"..."),this.htID=g,this.htCont=e,this.range=d,c)},unwrap:function(a){if(a){for(var b=a.parentNode;a.firstChild;)b.insertBefore(a.firstChild,a);b.removeChild(a)}},findHtId:function(a,b){if(b>5)return null;var c=a.attr("data-hc-id");return c?a:this.findHtId(a.parent(),++b)},checkPosition:function(a,b,c,d){function e(a){return null!==a.match(i)}function f(a){return null===a.match(i)}function g(a,b,c){for(;b>0&&c(a.data.charAt(b-1));)b--;return b}function h(a,b,c){if(!a.data)return b;for(;b<a.data.length&&c(a.data.charAt(b));)b++;return b}var i=this.opt.regexp;"start"==d&&(b=h(c,b,f),b=g(c,b,e),a.setStart(c,b)),"end"==d&&(b=g(c,b,f),b=h(c,b,e),a.setEnd(c,b))},streamMessage:function(a){this._reCount(a,1)},streamDelete:function(a){this._reCount(a,-1)},packets:function(a){var b=a.data[0].hypertext_id;this.streamMessage({hypertext_id:b})},_reCount:function(a,b){if(a.hypertext_id){var c=this.hashStore[a.hypertext_id],d=c.find("span"),e=d.html();"+"==e?(d.html("1"),c.show()):d.html(+e+b)}},share:function(b){var c,d=a(b.currentTarget).data("t"),e=this.app.m.Settings.get("href"),f=encodeURIComponent(e),g=encodeURIComponent(this.selFixText);switch(d){case"f":c="http://www.facebook.com/sharer/sharer.php?t="+g+"&u="+f;break;case"t":c="http://twitter.com//intent/tweet?text="+g+"&url="+f;break;case"v":c="http://vk.com/share.php?title="+g+"&url="+f}HC.Utils.popup(580,480,"ShareHyperComments",c)}}}(this.jHC,this.underscoreHC),function(a,b,c,d){a.HyperText.View=function(b){a.V.HT=c.View.extend({tpl:"HTPopup",initialize:function(a){this.auth=a.auth,this.info=a.info,this.htID=a.htID,this.selText=a.selText,b.IO.SOCKET_OPEN?this.collection.fetchHt({hypertext_id:a.htID}):(b.IO.connect(),b.IO.on("socket:open",function(){this.collection.fetchHt({hypertext_id:a.htID}),b.IO.off("socket:open")},this)),this.collection.on("reset",this.showComments,this),this.collection.on("add",this.showComments,this),this.render({htID:this.htID}),this._renderComments(),this._renderForm()},_renderComments:function(){this.CommentsView=new a.V.Comments({model:this.model,auth:this.auth,collection:this.collection,level:3,htID:this.htID,selText:this.selText,p_view:this}),this.HcContent.html(this.CommentsView.$el)},_renderForm:function(){this.model.get("readonly")?this.FormHc.html(a.tmpl("CloseDisqus",{readonly:this.model.get("readonly")})):(this.Form=new a.V.Form({model:this.auth,settings:this.model,info:this.info,htID:this.htID,selText:this.selText,comment:new a.M.Comment,commentsView:this.CommentsView}),this.FormHc.html(this.Form.$el),d.delay(function(){this.Form.HcText.click()}.bind(this),10),this.Form.on("resize_hc",function(a){"open"==a?this.HcContent.css("max-height",265):this.HcContent.removeAttr("style").scrollTop(0)}.bind(this)))},showComments:function(){this.$el.removeAttr("clear"),this.Loader.remove()}})}}(this.HC,this.jHC,this.BackboneHC,this.underscoreHC);